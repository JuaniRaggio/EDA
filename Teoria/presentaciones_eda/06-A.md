# Estructura de Datos y Algoritmos

# ITBA     2025-Q2

# Algoritmos para texto

El algoritmo KMP busca en forma eficiente la aparición exacta de un query en un texto\, tomando ventaja del procesamiento del “query”\.

Pero si quisiéramos buscar un query en un “grupo de documentos”\, nos conviene generar un índice de dicha colección para luego buscar a través del índice\.

Es decir\, preprocesar los documentos sobre los que se va a realizar la búsqueda \(el corpus\)\. Los términos que integran al corpus se denomina Vocabulario\.

Eso es lo que hacen las bibliotecas de  __Fulltext__  __ Retrieval__ \.

Un buscador como Google/Bing generan un índice de los documentos para facilitar la búsqueda\. La búsqueda se realiza a través del índice\.

Existe una biblioteca de código abierto para esto: Lucene

Está escrita en Java \([https://lucene\.apache\.org](https://lucene.apache.org/)[/](https://lucene.apache.org/)\) =>  escrita por Douglass Cutting en 1999\, en su primera versión\. Doug es uno de los fundadores de Apache Hadoop\.

Nos permite armar nuestro propio “search engine”\!\!\!

\(Ej: el buscador de Amazon vs el buscador de Jumbo\)

__¿__  __Qué__  __ __  __es__  __ un __  __índice__  __? ¿__  __Qué__  __ __  __tipo__  __ de __  __índice__  __ __  __usa__  __ __  __Lucene__  __?__

Un índice es una estructura que permite llegar rápidamente al dato buscado\. Si se agrega/elimina/actualiza un documento en la colección debe actualizarse\. Su ventaja está en la búsqueda\.

¿Qué índice resulta conveniente? ¿Cuál es el que usa Lucene?

Lucene usa un  __Archivo__  __ __  __Invertido__  __: “__  __conjunto__  __ de __  __términos__  __ que __  __dicen__  __ a __  __qué__  __ __  __documento__  __ __  __pertenece__  __”__

Es un mapping:  __término__  __ __  ____  __ __  __documento__ \.

_MapReduce_  _ _  _=> \{ Doc1\, Doc2 \}_

_e_  _s _  _=> \{Doc1\, Doc2 \}_

_…_

_t_  _écnica _  _=> \{Doc1\, Doc2\}_

_Grid_  _ => \{Doc2 \}_

_…_

![](img/06-A_0.png)

![](img/06-A_1.png)

<span style="color:#1ea907"> __Hazelcast__ </span>  <span style="color:#1ea907"> __ es un __ </span>  <span style="color:#1ea907"> __Grid__ </span>  <span style="color:#1ea907"> __ que implementa la técnica de __ </span>  <span style="color:#1ea907"> __MapReduce__ </span>

<span style="color:#1ea907"> __MapReduce__ </span>  <span style="color:#1ea907"> __ es una técnica de __ </span>  <span style="color:#1ea907"> __Divide&Conquer__ </span>  <span style="color:#1ea907"> __ distribuida__ </span>

_MapReduce_  _ => \{ Doc1\, Doc2 \}_

_es _  _=> \{Doc1\, Doc2 \}_

_…_

_técnica _  _=> \{Doc1\, Doc2\}_

_Grid_  _ => \{Doc2 \}_

_…_

_¿Cómo se usa el índice para _

_responder las consultas?_

![](img/06-A_2.png)

![](img/06-A_3.png)

<span style="color:#1ea907"> __Hazelcast__ </span>  <span style="color:#1ea907"> __ es un __ </span>  <span style="color:#1ea907"> __Grid__ </span>  <span style="color:#1ea907"> __ que implementa la técnica de __ </span>  <span style="color:#1ea907"> __MapReduce__ </span>

<span style="color:#1ea907"> __MapReduce__ </span>  <span style="color:#1ea907"> __ es una técnica de __ </span>  <span style="color:#1ea907"> __Divide&Conquer__ </span>  <span style="color:#1ea907"> __ distribuida__ </span>

![](img/06-A_4.jpg)

<span style="color:#1ea907"> __Rta:__ </span>

<span style="color:#1ea907"> __\{Doc1\, Doc2\}__ </span>

_MapReduce_  _ => \{ Doc1\, Doc2 \}_

_Es => \{Doc1\, Doc2 \}_

_…_

_Técnica => \{Doc1\, Doc2\}_

_Grid_  _ => \{Doc2 \}_

_…_

_¿Cómo se usa el índice para _

_responder las consultas?_

![](img/06-A_5.png)

![](img/06-A_6.png)

<span style="color:#1ea907"> __Hazelcast__ </span>  <span style="color:#1ea907"> __ es un __ </span>  <span style="color:#1ea907"> __Grid__ </span>  <span style="color:#1ea907"> __ que implementa la técnica de __ </span>  <span style="color:#1ea907"> __MapReduce__ </span>

<span style="color:#1ea907"> __MapReduce__ </span>  <span style="color:#1ea907"> __ es una técnica de __ </span>  <span style="color:#1ea907"> __Divide&Conquer__ </span>  <span style="color:#1ea907"> __ distribuida__ </span>

“MapReduce” && “Grid”?

![](img/06-A_7.jpg)

<span style="color:#1ea907"> __Rta:__ </span>

<span style="color:#1ea907"> __\{Doc1\, Doc2\} __ </span>  <span style="color:#1ea907"> __ \{ Doc2\}  __ </span>

<span style="color:#1ea907"> __o sea\, sólo \{Doc2\}__ </span>

_MapReduce_  _ => \{ Doc1\, Doc2 \}_

_Es => \{Doc1\, Doc2 \}_

_…_

_Técnica => \{Doc1\, Doc2\}_

_Grid_  _ => \{Doc2 \}_

_…_

_¿Cómo se usa el índice para _

_responder las consultas?_

![](img/06-A_8.png)

![](img/06-A_9.png)

<span style="color:#1ea907"> __Hazelcast__ </span>  <span style="color:#1ea907"> __ es un __ </span>  <span style="color:#1ea907"> __Grid__ </span>  <span style="color:#1ea907"> __ que implementa la técnica de __ </span>  <span style="color:#1ea907"> __MapReduce__ </span>

<span style="color:#1ea907"> __MapReduce__ </span>  <span style="color:#1ea907"> __ es una técnica de __ </span>  <span style="color:#1ea907"> __Divide&Conquer__ </span>  <span style="color:#1ea907"> __ distribuida__ </span>

“MapReduce”  \- “Grid”?

![](img/06-A_10.jpg)

<span style="color:#1ea907"> __Rta__ </span>  <span style="color:#1ea907"> __:__ </span>

<span style="color:#1ea907"> __\{Doc1\, Doc2\} __ </span>  <span style="color:#1ea907"> __\- __ </span>  <span style="color:#1ea907"> __\{ Doc2\}  __ </span>

<span style="color:#1ea907"> __o sea\, sólo \{__ </span>  <span style="color:#1ea907"> __Doc1\}__ </span>

# Lucene



* Concepto de documento\, campos\.
* Almacenamiento en Lucene: en el índice y fuera del índice
* Aplicaciones
  * IndexBuilder  \(creación de los documentos\)
  * TheSearcher \(búsqueda de documentos\)
* Queries:
  * API
  * QueryBuilder
* Formas de separar en tokens
* Ranking de documentos




* <span style="color:#00b050">Concepto de documento\, campos\.</span>
* Almacenamiento en Lucene: en el índice y fuera del índice
* Aplicaciones
  * IndexBuilder  \(creación de los documentos\)
  * TheSearcher \(búsqueda de documentos\)
* Queries:
  * API
  * QueryBuilder
* Formas de separar en tokens
* Ranking de documentos


__Documento en __  __Lucene__  __ \(definición\)__

Un  _Documento _  _Lucene_  _ _ es una secuencia de  _Campos \(_  _fields_  _\)_ \. Cuando se ingresa un documento en Lucene\, automáticamente se le asociará un ID \(docid\)\.

__Campo/Field en __  __Lucene__  __ \(definición\)__

Un  _Campo _  _Lucene_  _ _ es un par  _nombre_  y  _secuencia de 1 o más términos\._

Ej: creo un field que se llama “author” y contiene “Leticia Gomez”\. Según las configuraciones que use podré hacer que “Leticia Gomez” sea un único término \(token\) o dos términos \(2 tokens\)

__Término / __  __Term__  __ \(definición\) __

Un  _Término _  _Lucene_  _ _ es una secuencia de bytes  \(podrían interpretarse como String\, números\, etc\) asociada a cierto campo\.

Dos secuencias de bytes con igual contenido pero asociadas a 2 campos diferentes se consideran diferentes\.



* <span style="color:#00b050"> _Concepto de documento\, campos\._ </span>
* <span style="color:#00b050">Almacenamiento en </span>  <span style="color:#00b050">Lucene</span>  <span style="color:#00b050">: en el índice y fuera del índice</span>
* Aplicaciones
  * IndexBuilder  \(creación de los documentos\)
  * TheSearcher \(búsqueda de documentos\)
* Query:
  * API
  * QueryBuilder
* Formas de separar en tokens
* Ranking de documentos


# Creación de un Campo

Un field puede ser solo almacenable\, solo indexable o ambas cosas\.

Obligatorio que sea\, por lo menos\, alguna de ellas =>sino\, para qué está Lucene

Al crear un campo \(nombre y términos\) y asociarlo a cierto documento puedo optar por:

Almacenarlo en Lucene pero fuera del archivo invertido\. Eso significa que se lo almacena literal \(sin procesamiento: no se lo separa en tokens\, no se lo pasa a minúsculas\, no se eliminan los signos de puntuación\, etc\)\. O sea\, está en Lucene pero  __no está indexado => no participa de las búsquedas__ \.

Indexarlo en el archivo invertido Lucene\. Eso significa que tokenizado o no \(según lo configure\) forma parte de archivo invertido y sus términos \(tokens\) =>  __participan de las búsquedas\.__

Como crear un Field?

<span style="color:#0070c0">FieldType</span>  <span style="color:#0070c0"> </span>  <span style="color:#0070c0">aField</span>  <span style="color:#0070c0"> = </span>  <span style="color:#0070c0"> __new __ </span>  <span style="color:#0070c0"> __FieldType__ </span>  <span style="color:#0070c0"> __\(\);__ </span>

Sobre su almacenamiento literal\, fuera del archivo invertido

<span style="color:#0070c0">aField\.setStored</span>  <span style="color:#0070c0">\(       </span>  <span style="color:#0070c0"> __\);    __ </span>

<span style="color:#0070c0">true</span> :  se almacena

<span style="color:#0070c0">false</span> :  no se almacena

Sobre su indexación en el archivo invertido \(alguna de estas\)

<span style="color:#0070c0">aField\.setIndexOptions</span>  <span style="color:#0070c0"> __\(    \);__ </span>

<span style="color:#0070c0"> __IndexOptions\.NONE__ </span>  <span style="color:#0070c0"> __ __ </span> :  no se indiza

<span style="color:#0070c0"> __IndexOptions\.DOCS__ </span> :  se indiza cada término  solo con los doc ids en los que participa

<span style="color:#0070c0"> __IndexOptions\.DOCS\_AND\_FREQS__ </span> :  se indiza cada término con los doc ids en los que participa y frecuencia en ellos

<span style="color:#0070c0"> __IndexOptions\.DOCS\_AND\_FREQS\_AND\_POSITIONS__ </span> :  se indiza cada término con los doc ids en los que participa\, junto con  frecuencia y posiciones ordinales dentro de ellos

<span style="color:#0070c0"> __IndexOptions\.DOCS\_AND\_FREQS\_AND\_POSITIONS\_AND\_OFFSETS__ </span> :  se indiza cada término con los doc ids en los que participa\,  frecuencia en ellos\, posiciones ordinales y offsets dentro de ellos

Salvo que use IndexOptions\.NONE\, el archivo invertido está preparado para recibir la siguiente información que se completará según las opciones elegidas

Por cada campo tenemos una tabla ordenada ascendentemente por valor del término \(token\)\.

Hay tantas tablas como Fields indexados hayamos creado\.

Por eso la búsqueda se realizar por campos\.

| Value term | Freq en docs | __\[ __  __doc__  __id:freqs__  __ in __  __docid__  __:\[positions in __  __docid__  __\]__  __ :\[__  __startOffsets__  __ \- __  __endOffsets__  __ in __  __docid__  __\) \]__ |
| :-: | :-: | :-: |
|  |  |  |
|  |  |  |

_Ejemplo 1:_

Creo un documento con un único field llamado “ _content_ ”\. No lo almaceno fuera del índice invertido\, pero sí lo indizo sólo a nivel  <span style="color:#0070c0">IndexOptions\.DOCS</span>  <span style="color:#0070c0"> y </span>  <span style="color:#0070c0">tokenizo</span>

// itero creando documentos que van a Lucene

for\(  …  \)  \{

Document aDoc =  __new __  __Document__  __\(\);__

String text= “bla bla bla”;

FieldType fieldD =  __new __  __FieldType__  __\(\);__

__	__  __fieldD__ \.setStored\( __false\);__

fieldD\.setIndexOptions\( <span style="color:#0070c0">IndexOptions\.</span>  <span style="color:#0070c0"> _DOCS_ </span>  _\);_

aDoc\.add\( _new Field_  __\("__  _content_  __"\, text\, __  <span style="color:#ff0000"> __ __ </span>  __fieldD__  _ _  _\) _  _\);_

…\.

\}

De toda esta información se va a completar solo esto:

| Value term | Freq en docs | __\[ __  __doc__  __id:freqs__  __ in __  __docid__  __:\[positions in __  __docid__  __\]__  __ :\[__  __startOffsets__  __ \- __  __endOffsets__  __ in __  __docid__  __\) \]__ |
| :-: | :-: | :-: |
|  |  |  |
|  |  |  |

De acuerdo a lo anterior\, tengo una colección de 4 documentos formados por solo ese field “content”\.  Lo que se indiza es precisamente el contenido de los archivos a\.txt\, b\.txt\, c\.txt\, d\.txt

Como es el índice invertido?

Docid 0  \(a\.txt\)

Game video\,

review    game\.

Docid 0  \(a\.txt\)

| Value term | Freq en docs | \[ docid\] |
| :-: | :-: | :-: |
| game | 1 |  |
| store | 1 |  |

| 0 |  |  |  |
| :-: | :-: | :-: | :-: |


| 0 |  |  |  |
| :-: | :-: | :-: | :-: |


| Value term | Freq en docs | \[ docid \] |
| :-: | :-: | :-: |
| game | 1 |  |
| store | 1 |  |
| video | 1 |  |

| 0 |  |  |  |
| :-: | :-: | :-: | :-: |


| 0 |  |  |  |
| :-: | :-: | :-: | :-: |


| 1 |  |  |  |
| :-: | :-: | :-: | :-: |


| Value term | Freq en docs | \[ docid\] |
| :-: | :-: | :-: |
| game | 1 |  |
| review | 1 |  |
| store | 1 |  |
| video | 1 |  |

Game video\,

review    game\.

| 0 |  |  |  |
| :-: | :-: | :-: | :-: |
| 3 |  |  |  |

| 3 |  |  |  |
| :-: | :-: | :-: | :-: |


| 0 |  |  |  |
| :-: | :-: | :-: | :-: |


| 1 |  |  |  |
| :-: | :-: | :-: | :-: |
| 3 |  |  |  |

| Value term | Freq en docs | \[ docid \] |
| :-: | :-: | :-: |
| game | 2 |  |
| review | 1 |  |
| store | 1 |  |
| video | 2 |  |

| 0 |  |  |  |
| :-: | :-: | :-: | :-: |
| 3 |  |  |  |
| 2 |  |  |  |

| 3 |  |  |  |
| :-: | :-: | :-: | :-: |


| 0 |  |  |  |
| :-: | :-: | :-: | :-: |


| 1 |  |  |  |
| :-: | :-: | :-: | :-: |
| 3 |  |  |  |

Es decir\, en forma compacta el archivo invertido para el campo “content” tiene:

| Value term | Freq en docs | \[ docid \] |
| :-: | :-: | :-: |
| game | 3 |  |
| review | 1 |  |
| store | 1 |  |
| video | 2 |  |

Docid 0  \(a\.txt\)

Game video\,

review    game\.

| 0 |  |  |  |
| :-: | :-: | :-: | :-: |
| 3 |  |  |  |
| 2 |  |  |  |

| 3 |  |  |  |
| :-: | :-: | :-: | :-: |


| 0 |  |  |  |
| :-: | :-: | :-: | :-: |


| 1 |  |  |  |
| :-: | :-: | :-: | :-: |
| 3 |  |  |  |

_Ejemplo 2:_

Creo un documento con un único field llamado “ _content_ ”\. No lo almaceno fuera del índice invertido\, pero si lo indizo solo a nivel  <span style="color:#0070c0"> __IndexOptions__ </span>  <span style="color:#0070c0"> __\.__ </span>  <span style="color:#0070c0"> __ DOCS\_AND\_FREQS\_AND\_POSITIONS__ </span>  <span style="color:#0070c0"> __  __ </span>  <span style="color:#0070c0">y </span>  <span style="color:#0070c0">tokenizo</span>

// itero creando documentos que van a Lucene

for\(  …  \)  \{

Document aDoc =  __new __  __Document__  __\(\);__

String text= “bla bla bla”;

FieldType fieldD =  __new __  __FieldType__  __\(\);__

__	__  __fieldD__ \.setStored\( __false\);__

fieldD\.setIndexOptions\( <span style="color:#0070c0">IndexOptions</span>  <span style="color:#0070c0">\.</span>  <span style="color:#0070c0"> __ __ </span>  <span style="color:#0070c0"> __DOCS\_AND\_FREQS\_AND\_POSITIONS__ </span>  _\);_

aDoc\.add\( _new Field_  __\("__  _content_  __"\, text\, __  <span style="color:#ff0000"> __ __ </span>  __fieldD__  _ _  _\) _  _\);_

…\.

\}

De toda esta información se va a completar solo esto:

| Value term | Freq en docs | __\[ __  __doc__  __id:freqs__  __ in __  __docid__  __:\[positions in __  __docid__  __\]__  __ :\[__  __startOffsets__  __ \- __  __endOffsets__  __ in __  __docid__  __\) \]__ |
| :-: | :-: | :-: |
|  |  |  |
|  |  |  |

De acuerdo a lo anterior\, tengo una colección de 4 documentos formados por solo ese field “content”\.  Lo que se indiza es precisamente el contenido de los archivos a\.txt\, b\.txt\, c\.txt\, d\.txt

Como es el índice invertido?

Docid 0  \(a\.txt\)

Game video\,

review    game\.

Docid 0  \(a\.txt\)

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] \] |
| :-: | :-: | :-: |
| game | 1 |  |
| store | 1 |  |

| 0 | 1 | \[1\] |  |
| :-: | :-: | :-: | :-: |


| 0 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |


| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] \] |
| :-: | :-: | :-: |
| game | 1 |  |
| store | 1 |  |
| video | 1 |  |

| 0 | 1 | \[1\] |  |
| :-: | :-: | :-: | :-: |


| 0 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |


| 1 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |


| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] \] |
| :-: | :-: | :-: |
| game | 1 |  |
| review | 1 |  |
| store | 1 |  |
| video | 1 |  |

Game video\,

review    game\.

| 0 | 1 | \[1\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] |  |

| 3 | 1 | \[2\] |  |
| :-: | :-: | :-: | :-: |


| 0 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |


| 1 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 1 | \[1\] |  |

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] \] |
| :-: | :-: | :-: |
| game | 2 |  |
| review | 1 |  |
| store | 1 |  |
| video | 2 |  |

| 0 | 1 | \[1\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] |  |
| 2 | 1 | \[0\] |  |

| 3 | 1 | \[2\] |  |
| :-: | :-: | :-: | :-: |


| 0 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |


| 1 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 1 | \[1\] |  |

Es decir\, en forma compacta el archivo invertido para el campo “content” tiene:

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] \] |
| :-: | :-: | :-: |
| game | 3 |  |
| review | 1 |  |
| store | 1 |  |
| video | 2 |  |

Docid 0  \(a\.txt\)

Game video\,

review    game\.

| 0 | 1 | \[1\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] |  |
| 2 | 1 | \[0\] |  |

| 3 | 1 | \[2\] |  |
| :-: | :-: | :-: | :-: |


| 0 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |


| 1 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 1 | \[1\] |  |

_Ejemplo 3:_

Si lo indizo a nivel  <span style="color:#0070c0"> __IndexOptions__ </span>  <span style="color:#0070c0"> __\. DOCS\_AND\_FREQS\_AND\_POSITIONS\_AND\_OFFSETS __ </span>  <span style="color:#0070c0">y </span>  <span style="color:#0070c0">tokenizo</span>  <span style="color:#0070c0"> </span> con los mismos documentos\, cómo hubiera quedado el  índice archivo invertido?

La lista de offsets de cada término tiene el formato de intervalo \[startOffset\, endOffset\)

¿NO se puede calcular conociendo el término \(y su longitud\) y el ordinal que ocupa??

Rta: no

Solo mostramos como queda el token game\. \(Completen Uds\. Todo lo demás\)

| s | t | o | r | e | \, | \, |  | g | a | m | e |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |


Docid 0  \(a\.txt\)

Game video\,

review    game\.

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] <span style="color:#ff0000">:\[</span>  <span style="color:#ff0000">startOffsets</span>  <span style="color:#ff0000"> \- </span>  <span style="color:#ff0000">endOffsets</span>  <span style="color:#ff0000"> in </span>  <span style="color:#ff0000">docid</span>  <span style="color:#ff0000">\] </span> \] |
| :-: | :-: | :-: |
| game | 3 |  |
| Etc etc etc |  |  |

| 0 | 1 | \[1\] | \[  \[8\-12\)  \] |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] | \[  \[0\-4\)\, \[23\-27\) \] |
| 2 | 1 | \[0\] | \[  \[0\, 4\) \] |

| G | a | m | e |  | v | i | d | e | o | \, |  | \\r | \\n |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |


| r | e | v | i | e | w |  |  |  | g | a | m | e | \. |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |


Docid 0  \(a\.txt\)

Game video\,

review    game\.

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] <span style="color:#ff0000">:\[</span>  <span style="color:#ff0000">startOffsets</span>  <span style="color:#ff0000"> \- </span>  <span style="color:#ff0000">endOffsets</span>  <span style="color:#ff0000"> in </span>  <span style="color:#ff0000">docid</span>  <span style="color:#ff0000">\] </span> \] |
| :-: | :-: | :-: |
| game | 3 |  |
| Etc etc etc |  |  |

| 0 | 1 | \[1\] | \[  \[8\-12\)  \] |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] | \[  \[0\-4\)\, \[23\-27\) \] |
| 2 | 1 | \[0\] | \[  \[0\, 4\) \] |

Docid 0  \(a\.txt\)

| g | a | m | e |
| :-: | :-: | :-: | :-: |


Game video\,

review    game\.

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] <span style="color:#ff0000">:\[</span>  <span style="color:#ff0000">startOffsets</span>  <span style="color:#ff0000"> \- </span>  <span style="color:#ff0000">endOffsets</span>  <span style="color:#ff0000"> in </span>  <span style="color:#ff0000">docid</span>  <span style="color:#ff0000">\] </span> \] |
| :-: | :-: | :-: |
| game | 3 |  |
| Etc etc etc |  |  |

| 0 | 1 | \[1\] | \[  \[8\-12\)  \] |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] | \[  \[0\-4\)\, \[23\-27\) \] |
| 2 | 1 | \[0\] | \[  \[0\, 4\) \] |

Docid 0  \(a\.txt\)

Game video\,

review    game\.

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] <span style="color:#ff0000">:\[</span>  <span style="color:#ff0000">startOffsets</span>  <span style="color:#ff0000"> \- </span>  <span style="color:#ff0000">endOffsets</span>  <span style="color:#ff0000"> in </span>  <span style="color:#ff0000">docid</span>  <span style="color:#ff0000">\] </span> \] |
| :-: | :-: | :-: |
| game | 3 |  |
| Etc etc etc |  |  |

| 0 | 1 | \[1\] | \[  \[8\-12\)  \] |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] | \[  \[0\-4\)\, \[23\-27\) \] |
| 2 | 1 | \[0\] | \[  \[0\, 4\) \] |

_Ejemplo 4:_

¿ Qué se hubiera guardado en Lucene si hubiéramos solicitado \(más allá del índice y sus configuración\)  :  <span style="color:#ff0000">aField\.setStored</span>  <span style="color:#ff0000">\( </span>  <span style="color:#ff0000">yes   </span>  <span style="color:#ff0000"> __\);   __ </span>  __ __  __?__

// itero creando documentos que van a Lucene

for\(  …  \)  \{

Document aDoc =  __new __  __Document__  __\(\);__

String text= “bla bla bla”;

FieldType fieldD =  __new __  __FieldType__  __\(\);__

__	__  __fieldD__ \.setStored\( __false\);__

fieldD\.setIndexOptions\( <span style="color:#0070c0">IndexOptions\.</span>  <span style="color:#0070c0"> _DOCS_ </span>  _\);_

<span style="color:#ff0000">aField\.setStored</span>  <span style="color:#ff0000">\( yes   </span>  <span style="color:#ff0000"> __\);    __ </span>

aDoc\.add\( _new Field_  __\("__  _content_  __"\, text\, __  <span style="color:#ff0000"> __ __ </span>  __fieldD__  _ _  _\) _  _\);_

…\.

\}

Rta: fuera del archivo invertido se almacena literal la información en formato tradicional \(no invertido\)

Docid 0  \(a\.txt\)

| Doc Id | Field |  |
| :-: | :-: | :-: |
| 0 | content | store\,\, game |
| Etc etc etc |  |  |

Resumiendo: la base de la indexación corresponde a definir fields con cierta características => configurable

Lucene viene equipado con un Field muy especial que corresponden a cierta configuración/combinación muy usada\. Muchas veces es suficiente y en vez de generar un field y asociarles todas sus características podemos usarlo \(como si fueran un shortcut a cierta configuración\)\.

¿Cuál es el field predefinido?

__TextField__ : Maneja tipo de datos texto\. Se indexa y por default se tokenizada \(se pasa a minúscula\, se separa por signos de puntuación\)=>  <span style="color:#0070c0">Es como usar </span>  <span style="color:#0070c0">IndexOptions\.DOCS\_AND\_FREQS\_POSITIONS</span>

Como muchas veces este tipo de campos no se lee desde un string \(de pocos caracteres\) sino que se lo indiza desde un “stream” \(archivo grande\)\, Lucene solo ofrece: almacenarlo él por fuera del índice si no proviene de un stream\. Caso contrario estaría triplicado el espacio: en el stream \(file system\)\, en el índice \(para buscar\) y además otra vez literal fuera del archivo invertido\. Demasiado\!

Es decir\, la opción de almacenar solo ser podrá hacer si no viene de un stream\.

Usar un TextField es como usar todo esto:

FieldType fieldD =  __new __  __FieldType__  __\(\);__

__fieldD__ \.setStored\( __ ??  \);  // DEPENDE DE DONDE VENGA LA FUENTE__

fieldD\.setIndexOptions\( <span style="color:#0070c0">IndexOptions</span>  <span style="color:#0070c0">\.</span>  <span style="color:#0070c0"> __ __ </span>  <span style="color:#0070c0"> __DOCS\_AND\_FREQS\_AND\_POSITIONS__ </span>  _\);  // SIN OFFSET_

aDoc\.add\( _new Field_  __\("__  _content_  __"\, text\, __  <span style="color:#ff0000"> __ __ </span>  __fieldD__  _ \) \);_

_Pero solo una sentencia creo esa configuración_

String text=“bla bla bla”;

aDoc\.add\( _new _  _TextField_  __\("__  _content_  __"\, text\, __ Field\.Store\. __NO__  _ _  _\) \);_

_O bien_

aDoc\.add\( _new _  _TextField_  __\("__  _content_  __"\, text\, __ Field\.Store\. _YES_  _ _  _\) _  _\);_

_O _  _bien_  _ _  _si_  _ _  _tengo_  _ un reader _  _sobre_  _ un _  _archivo_  _:_

aDoc\.add\( _new _  _TextField_  __\("__  _content_  __"\, __  __ __  __aReader__  _\) _  _\);_

<span style="color:#0070c0">Como </span>  <span style="color:#0070c0">setStored</span>  <span style="color:#0070c0">\(false\)</span>

<span style="color:#0070c0">Como </span>  <span style="color:#0070c0">setStored</span>  <span style="color:#0070c0">\(true\)</span>

_Ejemplo 5:_

¿ Qué se hubiera guardado en Lucene si hubiéramos solicitado el siguiente código completando text desde los 4 archivos anteriores?

// itero creando documentos que van a Lucene

for\(  …  \)  \{

Document aDoc =  __new __  __Document__  __\(\);__

String text= “…”;

aDoc\.add\( _new _  _TextField_  __\("__  _content_  __"\, text\, __ Field\.Store\. _NO_  _ _  _\) _  _\);_

…\.

\}

Rta: lo mismo que hicimos en ejemplo 2\. Es decir:

Es decir\, en forma compacta el archivo invertido para el campo “content” tiene:

| Value term | Freq en docs | \[ docid:freqs in docid:\[positions in docid\] \] |
| :-: | :-: | :-: |
| game | 3 |  |
| review | 1 |  |
| store | 1 |  |
| video | 2 |  |

Docid 0  \(a\.txt\)

Game video\,

review    game\.

| 0 | 1 | \[1\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 2 | \[0\, 3\] |  |
| 2 | 1 | \[0\] |  |

| 3 | 1 | \[2\] |  |
| :-: | :-: | :-: | :-: |


| 0 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |


| 1 | 1 | \[0\] |  |
| :-: | :-: | :-: | :-: |
| 3 | 1 | \[1\] |  |

# Lucene



* <span style="color:#00b050"> _Concepto de documento\, campos\._ </span>
* <span style="color:#00b050"> _Almacenamiento en _ </span>  <span style="color:#00b050"> _Lucene_ </span>  <span style="color:#00b050"> _: en el índice y fuera del índice_ </span>
* <span style="color:#00b050">Aplicaciones</span>
  * IndexBuilder  \(creación de los documentos\)
  * TheSearcher \(búsqueda de documentos\)
* Query:
  * API
  * QueryBuilder
* Formas de separar en tokens
* Ranking de documentos


Las 2 aplicaciones independientes que precisamos realizar con Lucene son: IndexerBuilder y Searcher



* <span style="color:#00b050"> _Concepto de documento\, campos\._ </span>
* <span style="color:#00b050"> _Almacenamiento en _ </span>  <span style="color:#00b050"> _Lucene_ </span>  <span style="color:#00b050"> _: en el índice y fuera del índice_ </span>
* <span style="color:#00b050"> _Aplicaciones_ </span>
  * <span style="color:#00b050">IndexBuilder</span>  <span style="color:#00b050">  \(creación de los documentos\)</span>
  * TheSearcher \(búsqueda de documentos\)
* Query:
  * API
  * QueryBuilder
* Formas de separar en tokens
* Ranking de documentos


<span style="color:#0070c0">IndexBuilder</span>

Aplicación que se encarga de generar el índice a partir de un conjunto de documentos Lucene y lo deja almacenado en cierto directorio que le indiquemos para tal efecto\.

Lucene

Indice y StoreFields

![](img/06-A_11.jpg)

<span style="color:#0070c0">IndexBuilder</span>  <span style="color:#0070c0"> \(continuación\)</span>

Típicamente\, algunos de los datos de los documentos se toman de algún archivo de disco \(txt\, pdf\, doc\)\, aunque podrían crearse from scratch \(desde un String\)\. Si seguimos esa estrategia\, le debemos indicar uno/varios directorio/s dónde residen los documentos físicos\.

Lucene

Indice y StoreFields

![](img/06-A_12.jpg)

<span style="color:#0070c0">IndexBuilder</span>  <span style="color:#0070c0"> \(continuación\)</span>

Es nuestra responsabilidad mantener el índice actualizado\, es decir\, re ejecutar si queremos agregar documentos\, o re generar el índice si los documentos en disco fueron modificados\.

Lucene

Indice y StoreFields

![](img/06-A_13.jpg)



* <span style="color:#00b050"> _Concepto de documento\, campos\._ </span>
* <span style="color:#00b050"> _Almacenamiento en _ </span>  <span style="color:#00b050"> _Lucene_ </span>  <span style="color:#00b050"> _: en el índice y fuera del índice_ </span>
* <span style="color:#00b050"> _Aplicaciones_ </span>
  * <span style="color:#00b050"> _IndexBuilder_ </span>  <span style="color:#00b050"> _  \(creación de los documentos\)_ </span>
  * <span style="color:#00b050">TheSearcher</span>  <span style="color:#00b050"> \(búsqueda de documentos\)</span>
* Query:
  * API
  * QueryBuilder
* Formas de separar en tokens
* Ranking de documentos


<span style="color:#0070c0">TheSearcher</span>

Aplicación que se encarga de aceptar consultas y utiliza el índice construido para retornar los documentos \(ids\) que “matchearon” la consulta rankeados en cierto orden\.

# Proceso de búsqueda

![](img/06-A_14.png)

![](img/06-A_15.png)

El usuario expresa

una consulta Lucene

\(query\)

![](img/06-A_16.jpg)

Lucene consulta Indice\.

Le devuelve la lista de doc ids

que matchearon su query

en cierto orden \(ranking\)

# Proceso de búsqueda mejorado

![](img/06-A_17.png)

![](img/06-A_18.png)

El usuario expresa

una consulta \(query\)

![](img/06-A_19.jpg)

Lucene consulta Indice\.

Le devuelve la lista de doc ids

que matchearon su query

en cierto orden \(ranking\)

Muestro otros campos almacenados de los docs\,

Genero hyperlinks para abrir documentos\, etc

